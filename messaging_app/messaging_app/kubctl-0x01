#!/bin/bash

# kubctl-0x01 - Scale Django app in Kubernetes and test performance

set -e

DEPLOYMENT_NAME="django-messaging-deployment"
SERVICE_NAME="django-messaging-service"
NAMESPACE="default"

echo "Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 -n $NAMESPACE

echo "Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME -n $NAMESPACE

echo "Verifying pods are running..."
kubectl get pods -n $NAMESPACE -o wide

echo "Setting up port-forwarding for load testing..."
kubectl port-forward service/$SERVICE_NAME 8000:8000 -n $NAMESPACE &
PF_PID=$!
sleep 5  # giving port-forward time to start

echo "âš¡ Running load test with wrk..."
wrk -t4 -c100 -d30s http://127.0.0.1:8000/

echo "Monitoring resource usage..."
kubectl top pods -n $NAMESPACE

# Clean up port-forward
kill $PF_PID

echo "Scaling and load testing complete!"
